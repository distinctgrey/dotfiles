#!/usr/bin/env bash
set -euo pipefail

# Install Homebrew if missing
if ! command -v brew >/dev/null 2>&1; then
  echo "üç∫ Installing Homebrew..."
  echo "   This will require sudo access to create system directories."
  echo "   Please enter your password when prompted."
  echo ""

  # Check if we can sudo before attempting installation
  if ! sudo -n true 2>/dev/null; then
    echo "‚ö†Ô∏è  This script needs sudo access to install Homebrew."
    echo "   Please run: sudo -v"
    echo "   Then re-run this script."
    exit 1
  fi

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  echo "‚úÖ Homebrew installation complete!"
fi

eval "$(/opt/homebrew/bin/brew shellenv)" || true
brew update

# Tap + install brew-file (and thus brew-wrap)
brew tap rcmdnk/file
brew install brew-file

# Install everything from chezmoi-rendered Brewfile.
# If missing (e.g., first run edge case), initialize from data.
BREWFILE="$HOME/.Brewfile"

if [ ! -f "$BREWFILE" ]; then
  echo "Brewfile missing; rendering with chezmoi..."
  chezmoi apply "$BREWFILE"
fi

if [ ! -f "$BREWFILE" ]; then
  echo "ERROR: Brewfile still missing; aborting."
  exit 1
fi

echo "üì¶ Installing packages from Brewfile..."
brew file install --file "$BREWFILE"

echo "‚úÖ Homebrew packages installation complete!"
