#!/usr/bin/env bash
set -euo pipefail

# Install Homebrew if missing
if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c \
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(/opt/homebrew/bin/brew shellenv)" || true
brew update

# Tap + install brew-file (and thus brew-wrap)
brew tap rcmdnk/file
brew install brew-file

# Install everything from chezmoi-rendered Brewfile.
# If missing (e.g., first run edge case), initialize from data.
BREWFILE="$HOME/.Brewfile"

if [ ! -f "$BREWFILE" ]; then
  echo "Brewfile missing; rendering with chezmoi..."
  chezmoi apply "$BREWFILE"
fi

if [ ! -f "$BREWFILE" ]; then
  echo "ERROR: Brewfile still missing; aborting."
  exit 1
fi

brew file install --file "$BREWFILE"

echo "brew-file install complete."
