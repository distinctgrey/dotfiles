#!/usr/bin/env bash
set -euo pipefail

# Install Homebrew if missing
if ! command -v brew >/dev/null 2>&1; then
  echo "Installing Homebrew..."
  NONINTERACTIVE=1 /bin/bash -c \
    "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

eval "$(/opt/homebrew/bin/brew shellenv)" || true
brew update

# Tap + install brew-file (and thus brew-wrap)
brew tap rcmdnk/file
brew install brew-file

# Install everything from chezmoi-rendered Brewfile
BREWFILE="$HOME/.Brewfile"
if [ ! -f "$BREWFILE" ]; then
  echo "ERROR: $BREWFILE not found. Did chezmoi render dot_Brewfile?"
  exit 1
fi

brew file install --file "$BREWFILE"

echo "brew-file install complete."
