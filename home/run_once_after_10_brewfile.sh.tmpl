#!/usr/bin/env bash
set -euo pipefail

# Install Homebrew if missing
if ! command -v brew >/dev/null 2>&1; then
  echo "üç∫ Installing Homebrew..."
  echo "   This will require sudo access to create system directories."
  echo "   Please enter your password when prompted."
  echo ""

  # Check if we can sudo before attempting installation
  if ! sudo -n true 2>/dev/null; then
    echo "‚ö†Ô∏è  This script needs sudo access to install Homebrew."
    echo "   Please run: sudo -v"
    echo "   Then re-run this script."
    exit 1
  fi

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

  echo "‚úÖ Homebrew installation complete!"
fi

eval "$(/opt/homebrew/bin/brew shellenv)" || true
brew update

# Tap + install brew-file (and thus brew-wrap)
brew tap rcmdnk/file
brew install brew-file

# Install everything from chezmoi-rendered Brewfile.
# If missing (e.g., first run edge case), initialize from data.
BREWFILE="$HOME/.Brewfile"

if [ ! -f "$BREWFILE" ]; then
  echo "Brewfile missing; rendering with chezmoi..."
  chezmoi apply "$BREWFILE"
fi

if [ ! -f "$BREWFILE" ]; then
  echo "ERROR: Brewfile still missing; aborting."
  exit 1
fi

echo "üì¶ Installing packages from Brewfile..."

# Create temporary log file for detailed error tracking
BREW_LOG=$(mktemp)
FAILED_PACKAGES=""

# Try to install with detailed logging
if ! brew file install --file "$BREWFILE" 2>&1 | tee "$BREW_LOG"; then
  echo ""
  echo "‚ùå Homebrew installation failed!"
  echo ""

  # Extract specific conflict information
  if grep -q "conflicts with" "$BREW_LOG"; then
    echo "üîç Package conflicts detected:"
    grep "conflicts with" "$BREW_LOG" | sed 's/^/   /'
    echo ""
  fi

  # Extract other specific errors
  if grep -q "already installed" "$BREW_LOG"; then
    echo "‚ÑπÔ∏è  Some packages were already installed:"
    grep "already installed" "$BREW_LOG" | sed 's/^/   /'
    echo ""
  fi

  if grep -q "No available formula" "$BREW_LOG"; then
    echo "‚ùì Package not found errors:"
    grep "No available formula" "$BREW_LOG" | sed 's/^/   /'
    echo ""
  fi

  echo "üìã Full error log saved to: $BREW_LOG"
  echo ""
  echo "üõ†Ô∏è  To resolve:"
  echo "   1. Check the conflicts listed above"
  echo "   2. Edit ~/.Brewfile to remove conflicting packages"
  echo "   3. Or install packages individually:"
  echo "      brew install <package-name>"
  echo "      brew install --cask <cask-name>"
  echo "   4. Re-run: chezmoi apply"
  echo ""
  exit 1
else
  # Clean up log file on success
  rm -f "$BREW_LOG"
fi

echo "‚úÖ Homebrew packages installation complete!"
