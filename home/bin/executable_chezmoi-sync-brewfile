#!/usr/bin/env bash
set -euo pipefail

# chezmoi-sync-brewfile
# Syncs ~/.Brewfile to .chezmoidata/macos.yaml brew section
# Default: dry-run (prints diff). To write, pass --write.

BREWFILE="$HOME/.Brewfile"

usage() {
  cat <<'EOF'
Usage: chezmoi-sync-brewfile [--write]

Default behavior is DRY-RUN:
  - parses ~/.Brewfile
  - generates brew section for .chezmoidata/macos.yaml
  - shows a unified diff vs current macos.yaml brew section
  - exits without writing

To actually write:
  chezmoi-sync-brewfile --write
EOF
}

WRITE=false
if [[ "${1:-}" == "-h" || "${1:-}" == "--help" ]]; then
  usage
  exit 0
fi
if [[ "${1:-}" == "--write" ]]; then
  WRITE=true
fi

if [[ ! -f "$BREWFILE" ]]; then
  echo "ERROR: Brewfile not found at $BREWFILE" >&2
  exit 1
fi

if ! command -v chezmoi >/dev/null 2>&1; then
  echo "ERROR: chezmoi is required to locate the source dir." >&2
  exit 1
fi

# Determine chezmoi source dir
SOURCE_DIR="$(chezmoi dump-config \
  | sed -n 's/.*"sourceDir":[[:space:]]*"\([^"]*\)".*/\1/p' \
  | head -n1)"

if [[ -z "$SOURCE_DIR" || ! -d "$SOURCE_DIR" ]]; then
  echo "ERROR: Could not determine chezmoi sourceDir." >&2
  exit 1
fi

MACOS_YAML="$SOURCE_DIR/.chezmoidata/macos.yaml"
TMP_BREW_SECTION="$(mktemp -t brew-section.XXXXXX)"
TMP_MACOS_YAML="$(mktemp -t macos.yaml.XXXXXX)"

# Parse Brewfile into temporary files (alphabetized & unique)
TAPS_FILE="$(mktemp)"
FORMULAE_FILE="$(mktemp)"
CASKS_FILE="$(mktemp)"

grep -E '^[[:space:]]*tap[[:space:]]+"' "$BREWFILE" \
  | sed -E 's/^[[:space:]]*tap[[:space:]]+"([^"]+)".*/\1/' \
  | sort -u > "$TAPS_FILE"

grep -E '^[[:space:]]*brew[[:space:]]+"' "$BREWFILE" \
  | sed -E 's/^[[:space:]]*brew[[:space:]]+"([^"]+)".*/\1/' \
  | sort -u > "$FORMULAE_FILE"

grep -E '^[[:space:]]*cask[[:space:]]+"' "$BREWFILE" \
  | sed -E 's/^[[:space:]]*cask[[:space:]]+"([^"]+)".*/\1/' \
  | sort -u > "$CASKS_FILE"

render_list() {
  local file="$1"
  local indent="$2"
  if [ ! -s "$file" ]; then
    echo "${indent}[]"
  else
    while IFS= read -r item; do
      echo "${indent}- ${item}"
    done < "$file"
  fi
}

{
  echo "brew:"
  echo "    taps:"
  render_list "$TAPS_FILE" "        "
  echo ""
  echo "    formulae:"
  render_list "$FORMULAE_FILE" "        "
  echo ""
  echo "    casks:"
  render_list "$CASKS_FILE" "        "
} > "$TMP_BREW_SECTION"

# Create new macos.yaml with updated brew section
if [[ -f "$MACOS_YAML" ]]; then
  # Extract everything before the brew section, preserving structure
  awk '/^brew:/{exit} {print}' "$MACOS_YAML" > "$TMP_MACOS_YAML"
  echo "" >> "$TMP_MACOS_YAML"
else
  echo "macos:" > "$TMP_MACOS_YAML"
  echo "    # Configuration will be added here" >> "$TMP_MACOS_YAML"
  echo "" >> "$TMP_MACOS_YAML"
fi

# Add the new brew section
cat "$TMP_BREW_SECTION" >> "$TMP_MACOS_YAML"

# Show diff (dry-run always)
echo "=== DRY RUN: diff vs $MACOS_YAML ==="
if [[ -f "$MACOS_YAML" ]]; then
  diff -u "$MACOS_YAML" "$TMP_MACOS_YAML" || true
else
  echo "(macos.yaml does not exist yet; showing generated content)"
  cat "$TMP_MACOS_YAML"
fi
echo "=== END DRY RUN ==="
TAPS_COUNT=$(wc -l < "$TAPS_FILE" | tr -d ' ')
FORMULAE_COUNT=$(wc -l < "$FORMULAE_FILE" | tr -d ' ')
CASKS_COUNT=$(wc -l < "$CASKS_FILE" | tr -d ' ')
echo "Taps: $TAPS_COUNT, Formulae: $FORMULAE_COUNT, Casks: $CASKS_COUNT"

if ! $WRITE; then
  rm -f "$TMP_BREW_SECTION" "$TMP_MACOS_YAML" "$TAPS_FILE" "$FORMULAE_FILE" "$CASKS_FILE"
  exit 0
fi

# Write mode
mkdir -p "$(dirname "$MACOS_YAML")"

if [[ -f "$MACOS_YAML" ]]; then
  backup="${MACOS_YAML}.bak"
  cp -f "$MACOS_YAML" "$backup"
  echo "Backed up existing macos.yaml to $backup"
fi

mv -f "$TMP_MACOS_YAML" "$MACOS_YAML"
echo "Wrote $MACOS_YAML"

# Clean up temporary files
rm -f "$TMP_BREW_SECTION" "$TAPS_FILE" "$FORMULAE_FILE" "$CASKS_FILE"
